# EF Core Migrations & Rollback Guide

This document provides a comprehensive reference for managing Entity Framework Core migrations. Whether you are using the Package Manager Console (PMC) in Visual Studio or the .NET CLI, these commands will help you evolve your database schema safely and efficiently.

## Table of Contents

- [Introduction](#introduction)
- [Package Manager Console Commands](#package-manager-console-commands)
- [.NET CLI Commands](#net-cli-commands)
- [Common Migration Scenarios](#common-migration-scenarios)
- [Troubleshooting & Best Practices](#troubleshooting--best-practices)
- [Additional Resources](#additional-resources)

## Introduction

EF Core migrations allow you to incrementally update your database schema as your application's data model changes. Migrations help keep your database in sync with your model by generating code to transform the database schema. This guide outlines commands for:
- Enabling migrations (if needed)
- Creating new migrations
- Applying migrations to update the database
- Removing migrations when necessary
- Rolling back applied migrations

> **Note:** In EF Core, the "Enable-Migrations" command is not required as migrations are enabled implicitly when you add your first migration. This command is retained for developers familiar with EF6.

## Package Manager Console Commands

If you work within Visual Studio using the Package Manager Console, here are the key commands:

### 1. Enable Migrations (EF6 Style)
For EF Core, enabling migrations is implicit. However, for EF6 you would run:
```powershell
Enable-Migrations
```

### 2. Add a New Migration
After modifying your model, create a new migration by running:
```powershell
Add-Migration "MigrationName"
```
Replace `"MigrationName"` with a descriptive name (e.g., `AddCustomerTable`).

### 3. Update the Database
Apply all pending migrations to your database:
```powershell
Update-Database
```

### 4. Remove the Last Migration
If the last migration has not yet been applied to the database, you can remove it with:
```powershell
Remove-Migration
```

### 5. Rollback Applied Migrations
If a migration has already been applied and you need to roll it back, update the database to a previous state. For example, to rollback all migrations (i.e., revert to the initial state):
```powershell
Update-Database -Migration:0
```
Alternatively, to rollback only to a specific migration, use:
```powershell
Update-Database -Migration "PreviousMigrationName"
```

### 6. List Available Migrations
To view all migrations in your project:
```powershell
Get-Migrations
```

## .NET CLI Commands

For developers who prefer using the command line, EF Core supports migration commands via the .NET CLI:

### 1. Add a New Migration
```bash
dotnet ef migrations add MigrationName
```

### 2. Update the Database
```bash
dotnet ef database update
```

### 3. Remove the Last Migration
```bash
dotnet ef migrations remove
```

### 4. Generate a SQL Script for Migrations
To review or manually apply the SQL changes:
```bash
dotnet ef migrations script
```

## Common Migration Scenarios

- **Creating a New Migration:**  
  After updating your data model, run the migration add command to scaffold the necessary changes.
  - **PMC:** `Add-Migration "DescriptiveMigrationName"`
  - **CLI:** `dotnet ef migrations add DescriptiveMigrationName`

- **Updating the Database:**  
  Apply the migration to your database.
  - **PMC:** `Update-Database`
  - **CLI:** `dotnet ef database update`

- **Rolling Back a Migration:**  
  To undo changes:
  - If the migration hasn't been applied, simply remove it:
    - **PMC:** `Remove-Migration`
    - **CLI:** `dotnet ef migrations remove`
  - If already applied, rollback to a previous migration:
    - **PMC:** `Update-Database -Migration "TargetMigrationName"` or use `-Migration:0` to revert all changes
    - **CLI:** `dotnet ef database update TargetMigrationName`

- **Reviewing Migration History:**  
  Check which migrations have been applied:
  - **PMC:** `Get-Migrations`

## Troubleshooting & Best Practices

- **Backup Your Database:** Always back up your database before applying migrations in a production environment.
- **Review Generated SQL:** Use `dotnet ef migrations script` to review the SQL generated by your migrations.
- **Incremental Changes:** Apply migrations incrementally rather than batching many changes together.
- **Consistent Naming:** Use clear, descriptive names for migrations to ease tracking changes.
- **Version Control:** Keep migration files under version control with your code to ensure team consistency.

## Additional Resources

For further details, refer to the official [EF Core documentation](https://docs.microsoft.com/en-us/ef/core/managing-schemas/migrations/) for advanced scenarios such as customizing migrations and handling complex schema changes.

---

Happy coding, and may your migrations be smooth and rollback-proof!
